<!DOCTYPE html>
  <html lang="en">
    <head>
      <meta charset="utf-8">
      <title>Using Djot for Content — ackurat.github.io</title>
      <meta name="description" content="My site now has Djot support, which will make it easier to implement some microfeatures such as inline code highlighting and footnotes.">
      <meta name="author" content="Adam CL">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <link href="/index.xml" rel="alternate" type="application/rss+xml" title="ackurat.github.io">
      <meta name="ROBOTS" content="INDEX, FOLLOW">
      <meta property="og:title" content="Using Djot for Content — ackurat.github.io">
      <meta property="og:description" content="My site now has Djot support, which will make it easier to implement some microfeatures such as inline code highlighting and footnotes.">
      <meta property="og:type" content="article">
      <meta property="og:url" content="https://ackurat.github.io/using-djot-for-content/">
      <meta name="twitter:card" content="summary">
      <meta name="twitter:title" content="Using Djot for Content — ackurat.github.io">
      <meta name="twitter:description" content="My site now has Djot support, which will make it easier to implement some microfeatures such as inline code highlighting and footnotes.">
      <meta itemprop="name" content="Using Djot for Content — ackurat.github.io">
      <meta itemprop="description" content="My site now has Djot support, which will make it easier to implement some microfeatures such as inline code highlighting and footnotes.">
      
        <meta itemprop="datePublished" content="2025-02-18T06:00:00Z">
        <meta itemprop="dateModified" content="2025-02-18T06:00:00Z">
        <meta itemprop="wordCount" content="288">
        <meta itemprop="keywords" content="djot,elixir">
        <meta property="article:author" content="Adam CL">
        <meta property="article:section" content="Software">
        <meta property="article:tag" content="djot"><meta property="article:tag" content="elixir">
        <meta property="article:published_time" content="2025-02-18T06:00:00Z">
        <meta property="article:modified_time" content="2025-02-18T06:00:00Z">
      
      <link rel="canonical" href="https://ackurat.github.io/using-djot-for-content/">
      <link rel="stylesheet" href="/assets/app.css">
      <script>
        (function() {
        const theme = localStorage.getItem('theme') ||
            (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        document.documentElement.setAttribute('data-theme', theme);
        })();
      </script>
      
        <script data-goatcounter="https://ackurat.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
      
    </head>
    <body>
        <header class="flex justify-center py-4">
            <nav class="flex justify-between items-center gap-4 pb-6 px-2 text-lg font-bold tracking-wider w-full max-w-2xl">
                <a href="/">~/</a>
                <div class="flex flex-wrap gap-4">
                    <a href="/about/">About</a>
                    <a href="/archive/">Archive</a>
                    <a type="application/rss+xml" href="/index.xml">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-[1em] w-auto inline-block align-middle -mt-0.5" viewBox="0 0 24 24">
                        <!-- Icon from Logos free icons by Streamline - https://creativecommons.org/licenses/by/4.0/ -->
                            <g fill="currentColor" stroke="none" stroke-linejoin="round">
                                <path d="M1.5 19.5a3 3 0 1 0 6 0a3 3 0 1 0-6 0"></path>
                                <path d="M12.5 22.5c0-6.075-4.925-11-11-11v-3c7.732 0 14 6.268 14 14z" clip-rule="evenodd"></path>
                                <path d="M19.5 22.5c0-9.941-8.059-18-18-18v-3c11.598 0 21 9.402 21 21z" clip-rule="evenodd"></path>
                            </g>
                        </svg>
                    </a>
                    <button id="theme-toggle" class="cursor-pointer hover:opacity-70 transition-opacity" aria-label="Toggle theme">
                        <span id="theme-icon"></span>
                    </button>
                </div>
            </nav>
        </header>
        <main class="w-full">
            
  

  <div class="flex justify-center px-4">
  <div class="w-full max-w-2xl">
    
    <article class="text-l">
      <div class="flex flex-col mb-6">
        <span class="text-base">Feb 18, 2025</span>
        <h1 class="text-3xl">Using Djot for Content</h1>
        <div>
          <a class="text-base mr-2" href="/keywords/djot">djot</a><a class="text-base mr-2" href="/keywords/elixir">elixir</a>
        </div>
      </div>

      
<p>I’ve just set up the site to handle both <a href="https://djot.net">Djot</a> and Markdown for writing content. It was surprisingly easy! This post outlines how to do it using <a href="https://hexdocs.pm/nimble_publisher/">NimblePublisher</a> and a <a href="https://hexdocs.pm/djot/">Djot</a> parser.</p>
<p>We can <a href="https://hexdocs.pm/nimble_publisher/NimblePublisher.html#module-custom-html-converter">override</a> the HTML converter used by NimblePublisher by simply plugging in our own. Our converter needs to implement the <code>convert/4</code> function which returns the HTML as a string.</p>
<pre><code class="makeup elixir"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Convert</span><span class="w"> </span><span class="k" data-group-id="0391611756-1">do</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">convert</span><span class="p" data-group-id="0391611756-2">(</span><span class="c">_path</span><span class="p">,</span><span class="w"> </span><span class="n">body</span><span class="p">,</span><span class="w"> </span><span class="c">_attrs</span><span class="p">,</span><span class="w"> </span><span class="c">_optds</span><span class="p" data-group-id="0391611756-2">)</span><span class="w"> </span><span class="k" data-group-id="0391611756-3">do</span><span class="w">
    </span><span class="nc">Djot</span><span class="o">.</span><span class="n">to_html!</span><span class="p" data-group-id="0391611756-4">(</span><span class="n">body</span><span class="p" data-group-id="0391611756-4">)</span><span class="w">
  </span><span class="k" data-group-id="0391611756-3">end</span><span class="w">
</span><span class="k" data-group-id="0391611756-1">end</span><span class="w">
</span></code></pre>
<p>Since Djot is more or less a superset of Markdown, all previous content can be rendered successfully with the Djot parser. With the default HTML converter now defunct, NimblePublisher won’t apply the code highlighter, so we’ll need to add this to our <code>convert/4</code> function. Let’s create two small helpers, one to apply highlighting to all block code and one to inline code:</p>
<pre><code class="makeup elixir"><span class="kd">defp</span><span class="w"> </span><span class="nf">highlight_block_code</span><span class="p" data-group-id="9512772931-1">(</span><span class="n">body</span><span class="p" data-group-id="9512772931-1">)</span><span class="w"> </span><span class="k" data-group-id="9512772931-2">do</span><span class="w">
  </span><span class="n">block_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sr">~r/&lt;pre&gt;&lt;code(?:</span><span class="se">\s</span><span class="sr">+class=&quot;language-(</span><span class="se">\w</span><span class="sr">*)&quot;)?&gt;([^&lt;]*)&lt;</span><span class="se">\/</span><span class="sr">code&gt;&lt;</span><span class="se">\/</span><span class="sr">pre&gt;/</span><span class="w">

  </span><span class="nc">NimblePublisher</span><span class="o">.</span><span class="n">highlight</span><span class="p" data-group-id="9512772931-3">(</span><span class="n">body</span><span class="p">,</span><span class="w"> </span><span class="ss">regex</span><span class="p">:</span><span class="w"> </span><span class="n">block_code</span><span class="p" data-group-id="9512772931-3">)</span><span class="w">
</span><span class="k" data-group-id="9512772931-2">end</span><span class="w">

</span><span class="kd">defp</span><span class="w"> </span><span class="nf">highlight_inline_code</span><span class="p" data-group-id="9512772931-4">(</span><span class="n">body</span><span class="p" data-group-id="9512772931-4">)</span><span class="w"> </span><span class="k" data-group-id="9512772931-5">do</span><span class="w">
  </span><span class="n">inline_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sr">~r/(?&lt;!&lt;pre&gt;)&lt;code(?:</span><span class="se">\s</span><span class="sr">+class=&quot;language-(</span><span class="se">\w</span><span class="sr">*)&quot;)?&gt;([^&lt;]*)&lt;</span><span class="se">\/</span><span class="sr">code&gt;/</span><span class="w">

  </span><span class="nc">Regex</span><span class="o">.</span><span class="n">replace</span><span class="p" data-group-id="9512772931-6">(</span><span class="n">inline_code</span><span class="p">,</span><span class="w"> </span><span class="n">body</span><span class="p">,</span><span class="w"> </span><span class="k" data-group-id="9512772931-7">fn</span><span class="w"> </span><span class="p" data-group-id="9512772931-8">(</span><span class="n">block</span><span class="p">,</span><span class="w"> </span><span class="c">_lang</span><span class="p">,</span><span class="w"> </span><span class="c">_code</span><span class="p" data-group-id="9512772931-8">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
    </span><span class="nc">NimblePublisher</span><span class="o">.</span><span class="n">highlight</span><span class="p" data-group-id="9512772931-9">(</span><span class="n">block</span><span class="p">,</span><span class="w"> </span><span class="ss">regex</span><span class="p">:</span><span class="w"> </span><span class="n">inline_code</span><span class="p" data-group-id="9512772931-9">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">replace</span><span class="p" data-group-id="9512772931-10">(</span><span class="sr">~r/&lt;pre&gt;(.*)&lt;</span><span class="se">\/</span><span class="sr">pre&gt;/s</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\\</span><span class="s">1&quot;</span><span class="p" data-group-id="9512772931-10">)</span><span class="w">
  </span><span class="k" data-group-id="9512772931-7">end</span><span class="p" data-group-id="9512772931-6">)</span><span class="w">
</span><span class="k" data-group-id="9512772931-5">end</span><span class="w">
</span></code></pre>
<p>Now we can just pipe the HTML output from the parser through these functions, and we’ll get highlighting. There are a few considerations:</p>
<ul>
<li>
We need the new regexes since the default used in <code>NimblePublisher.highlight/2</code> doesn’t match anymore - the Djot parser uses an attribute like <code class="makeup html"><span class="na">class</span><span class="o">=</span><span class="s">&quot;language-elixir&quot;</span></code>.
</li>
<li>
The library I use for highlighting, <a href="https://hexdocs.pm/makeup/">Makeup</a> adds <code class="makeup html"><span class="p" data-group-id="4922651391-1">&lt;</span><span class="nt">pre</span><span class="p" data-group-id="4922651391-1">&gt;</span></code> tags around code. This messes up the inline code, hence the replace code to remove them.
</li>
</ul>
<p>All that is left to do now is tell NimblePublisher to use the converter, both on markdown and djot:</p>
<pre><code class="makeup elixir"><span class="kn">use</span><span class="w"> </span><span class="nc">NimblePublisher</span><span class="p">,</span><span class="w">
  </span><span class="ss">from</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;./pages/**/*.{md,dj}&quot;</span><span class="p">,</span><span class="w">
  </span><span class="ss">highlighters</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="1055461813-1">[</span><span class="ss">:makeup_elixir</span><span class="p" data-group-id="1055461813-1">]</span><span class="p">,</span><span class="w">
  </span><span class="ss">html_converter</span><span class="p">:</span><span class="w"> </span><span class="nc">Convert</span><span class="w">
  </span><span class="n">...</span><span class="w">
</span></code></pre>

    </article>

    <div class="-mx-4 my-2 flex h-1 w-[100vw] footer-gradient rounded-full sm:mx-0 sm:w-full"></div>
  <footer class="italic">
    
      <div class="flex justify-between">
        
          <a href="/one-year-retrospective-of-elixir">
            Previous
          </a>
        
        
          <a href="/once-again-rewriting-the-site">
            Next
          </a>
        
      </div>
    
  </footer>
  
  </div>
</div>

  <script>
  (function() {
    let lastHash = location.hash;

    function updateTOC(sectionId) {
      document.querySelectorAll('[data-toc-link]').forEach(function(link) {
        link.setAttribute('data-active', link.dataset.tocLink === sectionId);
      });
    }

    document.addEventListener('scroll', function() {
      const sections = document.querySelectorAll('h1[id], h2[id], h3[id], h4[id], h5[id], h6[id], section[id]');
      let currentSection = null;

      sections.forEach(function(section) {
        if (window.scrollY >= section.offsetTop - 100) {
          currentSection = section;
        }
      });

      // If at bottom of page, use the last section
      if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 10) {
        currentSection = sections[sections.length - 1];
      }

      if (currentSection && currentSection.id) {
        const newHash = '#' + currentSection.id;
        if (lastHash !== newHash) {
          history.replaceState(null, '', location.origin + location.pathname + newHash);
          lastHash = newHash;
          updateTOC(currentSection.id);
        }
      }
    });

    if (location.hash) {
      updateTOC(decodeURIComponent(location.hash.substring(1)));
    }
  })();
</script>

        </main>
        <script>
            const themeToggle = document.getElementById('theme-toggle');
            const themeIcon = document.getElementById('theme-icon');
            const html = document.documentElement;

            function updateIcon() {
              const currentTheme = html.getAttribute('data-theme');
              themeIcon.textContent = currentTheme === 'dark' ? '☼' : '☾';
            }

            updateIcon();

            themeToggle.addEventListener('click', () => {
              const currentTheme = html.getAttribute('data-theme');
              const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
              html.setAttribute('data-theme', newTheme);
              localStorage.setItem('theme', newTheme);
              updateIcon();
            });
        </script>
    </body>
  </html>